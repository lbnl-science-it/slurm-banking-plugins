<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-12-06 Fri 10:11 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Slurm Banking Plugins</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Slurm Banking Plugins</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org2fbd564">1. Introduction</a></li>
<li><a href="#orgef3cd69">2. Limitations</a></li>
<li><a href="#org7205880">3. Build Requirements</a></li>
<li><a href="#orgab2659d">4. Building</a>
<ul>
<li><a href="#orgc1ab53e">4.1. On Savio</a></li>
<li><a href="#orgfc51541">4.2. NixOS</a></li>
<li><a href="#org3ab7569">4.3. Help</a></li>
</ul>
</li>
<li><a href="#org6baec6a">5. Usage</a>
<ul>
<li><a href="#org6badf2f">5.1. Install, enable, and configure</a>
<ul>
<li><a href="#org0813f80">5.1.1. Install the <code>.so</code> files</a></li>
<li><a href="#org05705a0">5.1.2. /etc/slurm/slurm.conf</a></li>
<li><a href="#orga6608b5">5.1.3. /etc/slurm/plugstack.conf</a></li>
<li><a href="#org996897d">5.1.4. /etc/slurm/bank-config.toml</a></li>
</ul>
</li>
<li><a href="#org4e049ad">5.2. Help/Debugging</a></li>
</ul>
</li>
<li><a href="#orgc79e088">6. Developing</a>
<ul>
<li><a href="#orga633ffc">6.1. Project Structure</a></li>
<li><a href="#org9ff4049">6.2. myBRC API Codegen</a></li>
<li><a href="#org6e91db2">6.3. Testing with myBRC</a></li>
<li><a href="#org9f83b19">6.4. Creating a Release</a></li>
</ul>
</li>
</ul>
</div>
</div>
<a href="https://travis-ci.org/ucb-rit/slurm-banking-plugins"><img src="https://travis-ci.org/ucb-rit/slurm-banking-plugins.svg?branch=master"></a> <a href="."><img src="https://img.shields.io/github/languages/top/ucb-rit/slurm-banking-plugins"></a> <a href="."><img src="https://img.shields.io/github/repo-size/ucb-rit/slurm-banking-plugins"></a>

<div id="outline-container-org2fbd564" class="outline-2">
<h2 id="org2fbd564"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
Slurm banking plugins provide allocation management to Slurm. The plugins deduct service units for completed and running jobs and prevent jobs from running if there are insufficient service units available. The plugins interact with a REST API (provided by myBRC), documented in the <a href="./spec/swagger.json">spec/swagger.json</a>. The following three plugins are used:
</p>

<ul class="org-ul">
<li><a href="./job_submit_plugin">job_submit_plugin</a> (job submission stage): Estimate maximum job cost based on submission parameters, and reject job if the API reports that the user/account has insufficient service units available.</li>
<li><a href="./spank_plugin">spank_plugin</a> (job running stage): Report job and estimated cost to the API.</li>
<li><a href="./job_completion_plugin">job_completion_plugin</a> (job completing stage): Modify job in API to reflect actual usage.</li>
</ul>

<p>
These plugins are written in <a href="https://www.rust-lang.org">Rust</a> to help with safety. It uses <a href="https://github.com/rust-lang/rust-bindgen">rust-bindgen</a> to automatically generate the Rust foreign function interface (FFI) bindings based on the Slurm C header files.
</p>
</div>
</div>

<div id="outline-container-orgef3cd69" class="outline-2">
<h2 id="orgef3cd69"><span class="section-number-2">2</span> Limitations</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>Since the spank plugin cannot cancel a job, the user could overdraw their service unit allocation if they had enough service units at the time of submission, but not enough service units at the time the job starts running, since the units are only actually deducted from the balance when the job starts running.</li>
<li>If <code>--ntasks</code> or <code>--cpus-per-task</code> are unspecified, the job completion plugin will assume the value is 0 and will always allow the job, as long as the balance is non-negative. This can be improved in the future by checking whether the requested partition is exclusive and how many CPUs each node has, and then using that information to estimate the number of CPUs that will be used.</li>
<li>If the myBRC API is offline (or returns errors), the submit plugin will let the job go through.</li>
</ul>
</div>
</div>

<div id="outline-container-org7205880" class="outline-2">
<h2 id="org7205880"><span class="section-number-2">3</span> Build Requirements</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li><a href="https://www.rust-lang.org/">Rust</a> (including <a href="https://doc.rust-lang.org/cargo/">cargo</a>)</li>
<li><a href="https://github.com/SchedMD/slurm">Slurm</a> header files and source code</li>
<li><a href="http://clang.llvm.org/get_started.html">Clang</a> (dependency for <a href="https://rust-lang.github.io/rust-bindgen/requirements.html">rust-bindgen</a>)</li>
</ul>
</div>
</div>

<div id="outline-container-orgab2659d" class="outline-2">
<h2 id="orgab2659d"><span class="section-number-2">4</span> Building</h2>
<div class="outline-text-2" id="text-4">
<p>
Since the Slurm <code>jobcomp</code> plugins need access to the <code>src/common/slurm_jobcomp.h</code> header, we need access to the Slurm source code <code>src</code> directory in order to build (as well as the normal <code>&lt;slurm/slurm.h&gt;</code> headers on the <code>CPATH</code>). 
</p>

<p>
You will have to first run <code>./configure</code> on the Slurm source code, otherwise <code>&lt;slurm/slurm.h&gt;</code> will not exist. If you don't run <code>./configure</code>, the Makefile will try to do it for you.
</p>

<ol class="org-ol">
<li>Edit the path at the top of the Makefile to point to the Slurm source code directory, or symlink <code>./slurm</code> in this repository to point to it.</li>
<li>Once you have all the dependencies, just run <code>make</code> :)</li>
<li>After building, you will find the <code>.so</code> files in the same directory as the Makefile.</li>
</ol>
</div>

<div id="outline-container-orgc1ab53e" class="outline-3">
<h3 id="orgc1ab53e"><span class="section-number-3">4.1</span> On Savio</h3>
<div class="outline-text-3" id="text-4-1">
<p>
You will need the Rust and <code>clang</code> dependencies. 
Rust can be installed following the instructions on <a href="https://rustup.rs">rustup.rs</a>, and is easiest if installed locally for each user. 
<code>clang</code> can be loaded as a module (or by setting the environment variables).
</p>

<p>
The plugins can be built as an unprivileged user, as long as that user can read the Slurm source code.
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">After installing Rust (using rustup)...</span>
module load clang
git clone https://github.com/ucb-rit/slurm-banking-plugins.git &amp;&amp; <span style="color: #4f97d7;">cd</span> slurm-banking-plugins
rmdir slurm &amp;&amp; ln -s /path/to/slurm/source slurm <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Point to slurm source</span>
make
</pre>
</div>

<p>
Then, follow the instructions in <a href="#org4150183">Usage</a> to install, enable, and configure the plugins.
</p>

<p>
<b>When adding the .so binaries to the nodes with Warewulf, you must use "wwsh file import" instead of "wwsh file new". Make sure the format in "wwsh file print" is listed as binary.</b>
</p>
</div>
</div>

<div id="outline-container-orgfc51541" class="outline-3">
<h3 id="orgfc51541"><span class="section-number-3">4.2</span> NixOS</h3>
<div class="outline-text-3" id="text-4-2">
<p>
<code>shell.nix</code> provides the environment for development on <a href="https://nixos.org">NixOS</a>. I run the following:
</p>

<div class="org-src-container">
<pre class="src src-bash">nix-shell 
make
</pre>
</div>
</div>
</div>

<div id="outline-container-org3ab7569" class="outline-3">
<h3 id="org3ab7569"><span class="section-number-3">4.3</span> Help</h3>
<div class="outline-text-3" id="text-4-3">
<p>
For additional reference on building, check <a href="https://travis-ci.org/ucb-rit/slurm-banking-plugins">the build on travis-ci</a>.
</p>
</div>
</div>
</div>

<div id="outline-container-org6baec6a" class="outline-2">
<h2 id="org6baec6a"><span class="section-number-2">5</span> <a id="org4150183"></a> Usage</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org6badf2f" class="outline-3">
<h3 id="org6badf2f"><span class="section-number-3">5.1</span> Install, enable, and configure</h3>
<div class="outline-text-3" id="text-5-1">
</div>
<div id="outline-container-org0813f80" class="outline-4">
<h4 id="org0813f80"><span class="section-number-4">5.1.1</span> Install the <code>.so</code> files</h4>
<div class="outline-text-4" id="text-5-1-1">
<p>
The <code>job_submit_slurm_banking.so</code> and <code>jobcomp_slurm_banking.so</code> should be installed in <code>/usr/lib64/slurm/</code>. The <code>spank_slurm_banking.so</code> plugin should be installed in <code>/etc/slurm/spank/</code>.
</p>
<div class="org-src-container">
<pre class="src src-shell">make install
</pre>
</div>
</div>
</div>

<div id="outline-container-org05705a0" class="outline-4">
<h4 id="org05705a0"><span class="section-number-4">5.1.2</span> /etc/slurm/slurm.conf</h4>
<div class="outline-text-4" id="text-5-1-2">
<p>
Enable the submit and completion plugins:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">other config options above...</span>
<span style="color: #7590db;">JobSubmitPlugins</span>=job_submit/slurm_banking
<span style="color: #7590db;">JobCompType</span>=jobcomp/slurm_banking
</pre>
</div>
</div>
</div>

<div id="outline-container-orga6608b5" class="outline-4">
<h4 id="orga6608b5"><span class="section-number-4">5.1.3</span> /etc/slurm/plugstack.conf</h4>
<div class="outline-text-4" id="text-5-1-3">
<p>
Enable the spank plugin:
</p>
<div class="org-src-container">
<pre class="src src-shell">required /etc/slurm/spank/spank_slurm_banking.so
</pre>
</div>
</div>
</div>

<div id="outline-container-org996897d" class="outline-4">
<h4 id="org996897d"><span class="section-number-4">5.1.4</span> /etc/slurm/bank-config.toml</h4>
<div class="outline-text-4" id="text-5-1-4">
<p>
Configure the plugin settings. Options that <b>must</b> be set properly include the API URL, API token, and partition names. You can use the example provided as a template.
</p>
<div class="org-src-container">
<pre class="src src-shell">cp bank-config.toml.example /etc/slurm/bank-config.toml
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org4e049ad" class="outline-3">
<h3 id="org4e049ad"><span class="section-number-3">5.2</span> Help/Debugging</h3>
<div class="outline-text-3" id="text-5-2">
<ul class="org-ul">
<li>The plugins log errors to the slurmd (spank plugin) and slurmctld (job submit and job completion plugins) logs. You can filter for their output by grepping for <code>_bank</code>.</li>
<li>For a working example installation, refer to <a href="./docker">the Docker files</a></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgc79e088" class="outline-2">
<h2 id="orgc79e088"><span class="section-number-2">6</span> Developing</h2>
<div class="outline-text-2" id="text-6">
<p>
I use the <a href="https://github.com/giovtorres/docker-centos7-slurm">docker-centos7-slurm</a> Docker container as a base, and build the plugins on top of it. 
</p>

<p>
<code>make docker-dev</code> builds the development container with Slurm plus all the other necessary dependencies for the plugins and drops you into a shell. The code is stored in <code>/slurm-banking-plugins</code> in the container. After making your changes, use <code>make &amp;&amp; make install</code> to compile and install the plugins, copy the <code>plugstack.conf</code> and <code>bank-config.toml</code> config files to <code>/etc/slurm/</code>, and finally restart Slurm with <code>supervisorctl restart all</code>.
</p>
</div>

<div id="outline-container-orga633ffc" class="outline-3">
<h3 id="orga633ffc"><span class="section-number-3">6.1</span> Project Structure</h3>
<div class="outline-text-3" id="text-6-1">
<p>
Each plugin is its own Rust project: <a href="./job_completion_plugin">job_completion_plugin</a>, <a href="./job_submit_plugin">job_submit_plugin</a>, and <a href="./spank_plugin">spank_plugin</a>. Each of these uses the <a href="./slurm_banking">slurm_banking</a> project, which includes the job calculation functionality and helpers for calling the API. Communication with the myBRC API is done through <a href="./mybrc_rest_client">mybrc_rest_client</a>, described in the next section.
</p>
</div>
</div>

<div id="outline-container-org9ff4049" class="outline-3">
<h3 id="org9ff4049"><span class="section-number-3">6.2</span> myBRC API Codegen</h3>
<div class="outline-text-3" id="text-6-2">
<p>
I use <a href="https://github.com/swagger-api/swagger-codegen">swagger-codegen</a> to generate a library to abstract away access to the API. The API is described by a schema file in <a href="./spec/swagger.json">spec/swagger.json</a>. This file is automatically generated by the myBRC API, and can be obtained at <code>/swagger.json</code> on the myBRC API.
</p>

<p>
If the API spec changes and you need to update this plugin, just regenerate the API client. First, put the new <code>swagger.json</code> in <a href="./spec/swagger.json">spec/swagger.json</a>. To generate the API client based on this new schema, I use the Dockerized version of <a href="https://github.com/swagger-api/swagger-codegen">swagger-codegen</a> like so:
</p>

<div class="org-src-container">
<pre class="src src-shell">docker run --rm -v $<span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">pwd</span><span style="color: #4f97d7;">)</span>:/local swaggerapi/swagger-codegen-cli generate <span style="color: #2d9574;">\</span>
  -i /local/spec/swagger.json <span style="color: #2d9574;">\</span>
  -l rust <span style="color: #2d9574;">\</span>
  -o /local/mybrc_rest_client
</pre>
</div>

<p>
You may find the generated files are not owned by your user, so just run <code>chown -R $USER mybrc_rest_client</code>.
</p>
</div>
</div>

<div id="outline-container-org6e91db2" class="outline-3">
<h3 id="org6e91db2"><span class="section-number-3">6.3</span> Testing with myBRC</h3>
<div class="outline-text-3" id="text-6-3">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Build mybrc-rest Docker image from scgup</span>
docker build -f Dockerfile.mybrc-rest -t mybrc-rest

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Build slurm-banking-plugins-dev image</span>
make docker-dev

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Launch containers</span>
docker run --name=mybrc-rest -d -p <span style="color: #a45bad;">8181:8181</span> mybrc-rest
docker run <span style="color: #2d9574;">\</span>
  -v $<span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">pwd</span><span style="color: #4f97d7;">)</span>/job_submit_plugin/src:/slurm-banking-plugins/job_submit_plugin/src <span style="color: #2d9574;">\</span>
  -v $<span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">pwd</span><span style="color: #4f97d7;">)</span>/job_completion_plugin/src:/slurm-banking-plugins/job_completion_plugin/src <span style="color: #2d9574;">\</span>
  -v $<span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">pwd</span><span style="color: #4f97d7;">)</span>/slurm_banking/src:/slurm-banking-plugins/slurm_banking/src <span style="color: #2d9574;">\</span>
  --link mybrc-rest -it -h ernie slurm-banking-plugins-dev
</pre>
</div>
</div>
</div>
<div id="outline-container-org9f83b19" class="outline-3">
<h3 id="org9f83b19"><span class="section-number-3">6.4</span> Creating a Release</h3>
<div class="outline-text-3" id="text-6-4">
<p>
GitHub Actions is set up to automatically build <a href="https://github.com/ucb-rit/slurm-banking-plugins/releases">releases</a> for tags starting with a <code>v</code>.
For example, if I push a tag <code>v0.1.0</code>, it will build releases for the code at that point.
There is a GitHub action to build using Docker for CentOS 6 and CentOS 7. In each of these,
you may specify the version of Slurm to compile against in the "Compile plugins" stage by changing
the tag to checkout of the Slurm source code. The GitHub actions are in <a href="./.github/workflows">.github/workflows</a>. 
In this example, it's using <code>slurm-18-08-7-1</code> in the CentOS 6 build environment:
</p>

<div class="org-src-container">
<pre class="src src-yaml">- <span style="color: #7590db;">name</span>: Compile plugins
  <span style="color: #7590db;">run</span>: |
    scripts/build-with-docker.sh slurm-18-08-7-1 slurm-banking-plugins-centos6:latest
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2019-12-06 Fri 10:11</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
